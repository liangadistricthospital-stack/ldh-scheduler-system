<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDH Schedule Portal</title>
    <style>
        :root { --primary: #10b981; --primary-dark: #059669; --secondary: #f59e0b; --bg: #f8fafc; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        /* Modal for Masterlist */
        #mlModal { 
            display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); justify-content: center; align-items: center; 
        }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 500px; max-height: 80vh; overflow-y: auto; }
        
        .header-box { display: flex; align-items: center; justify-content: space-between; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .action-bar { display: flex; justify-content: space-between; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; gap: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 12px; text-transform: uppercase; color: #64748b; }
        td { border-bottom: 1px solid #f1f5f9; padding: 8px; }
        
        .staff-name { font-weight: bold; display: block; color: #1e293b; }
        .staff-role { font-size: 11px; color: #94a3b8; font-style: italic; }
        
        button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 16px; font-weight: 600; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-accent { background: var(--secondary); color: white; }
        .btn-outline { background: #e2e8f0; color: #475569; }
        
        input[type="text"] { width: 90%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        select { width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; }

        .signatories { margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .sig-block { border-top: 1px solid #cbd5e1; padding-top: 10px; }

        @media print { .action-bar, #mlModal, .btn-del { display: none !important; } }
    </style>
</head>
<body>

<div id="loginPage" style="text-align:center; margin-top:100px;">
    <h2>LDH PORTAL</h2>
    <select id="deptSelect" style="width:200px; padding:10px;">
        <option value="Nursing">Nursing</option>
        <option value="eClaims">eClaims</option>
        <option value="Laboratory">Laboratory</option>
        <option value="Radiology">Radiology</option>
        <option value="Pharmacy">Pharmacy</option>
    </select><br><br>
    <button class="btn-main" onclick="login()">Login</button>
</div>

<div id="mainPage" style="display:none;">
    <div class="header-box">
        <div style="text-align:center; width:100%">
            <h1 id="deptTitle">DEPARTMENT</h1>
            <h3 id="weekDisplay"></h3>
        </div>
    </div>

    <div class="action-bar">
        <div>
            <button class="btn-outline" onclick="changeWeek(-7)">â—€ Previous</button>
            <button class="btn-outline" onclick="changeWeek(7)">Next â–¶</button>
        </div>
        <div>
            <button class="btn-accent" onclick="openMasterlist()">ðŸ“‹ MANAGE MASTERLIST</button>
            <button class="btn-main" onclick="saveData()">ðŸ’¾ SAVE ALL CHANGES</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width:200px">Staff & Designation</th>
                <th>Sat</th><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th>
                <th class="btn-del"></th>
            </tr>
        </thead>
        <tbody id="scheduleBody"></tbody>
    </table>

    <div class="signatories">
        <div class="sig-block">
            <p>Prepared by:</p>
            <strong contenteditable="true" id="prepName">Name</strong><br>
            <span contenteditable="true" id="prepRole">Role</span>
        </div>
        <div class="sig-block">
            <p>Approved by:</p>
            <strong contenteditable="true" id="apprName">Name</strong><br>
            <span contenteditable="true" id="apprRole">Role</span>
        </div>
    </div>
</div>

<div id="mlModal">
    <div class="modal-content">
        <h3>Masterlist Management</h3>
        <p>Add staff here once. They will appear every week automatically.</p>
        <table id="mlTable">
            <thead><tr><th>Name</th><th>Role</th><th></th></tr></thead>
            <tbody id="mlBody"></tbody>
        </table><br>
        <button class="btn-outline" onclick="addMlRow()">+ Add Staff</button>
        <div style="text-align:right">
            <button class="btn-outline" onclick="closeMasterlist()">Cancel</button>
            <button class="btn-main" onclick="saveMasterlist()">Save Masterlist</button>
        </div>
    </div>
</div>

<script>
    let currentDept = "";
    let currentSat = new Date();
    // Move to the most recent Saturday
    currentSat.setDate(currentSat.getDate() - (currentSat.getDay() + 1) % 7);

    // Global Data Store
    let db = JSON.parse(localStorage.getItem('LDH_DB')) || {
        schedules: {}, // Keyed by Date + Dept
        masterlists: {}, // Keyed by Dept
        sigs: {} // Keyed by Dept
    };

    function login() {
        currentDept = document.getElementById('deptSelect').value;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        document.getElementById('deptTitle').innerText = currentDept + " Department";
        loadData();
    }

    function loadData() {
        const weekKey = currentSat.toDateString();
        const schedKey = weekKey + "_" + currentDept;
        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = "";

        // DISPLAY WEEK RANGE
        let end = new Date(currentSat);
        end.setDate(end.getDate() + 6);
        document.getElementById('weekDisplay').innerText = currentSat.toLocaleDateString() + " - " + end.toLocaleDateString();

        // 1. TRY LOADING SAVED DATA FOR THIS WEEK
        let rows = db.schedules[schedKey];

        // 2. IF EMPTY, TRY LOADING MASTERLIST
        if (!rows || rows.length === 0) {
            let ml = db.masterlists[currentDept] || [];
            if (ml.length > 0) {
                rows = ml.map(staff => ({ name: staff.name, role: staff.role, shifts: ["","","","","","",""] }));
            }
        }

        // 3. IF STILL EMPTY, ADD 3 BLANK ROWS
        if (!rows || rows.length === 0) {
            rows = [ {name: "", role: "", shifts: ["","","","","","",""]} ];
        }

        rows.forEach(r => addRow(r));
        loadSigs();
    }

    function addRow(data) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <span class="staff-name" contenteditable="true">${data.name || "Name"}</span>
                <span class="staff-role" contenteditable="true">${data.role || "Role"}</span>
            </td>
            ${data.shifts.map(s => `<td><select>${getOptions(s)}</select></td>`).join('')}
            <td class="btn-del"><button onclick="this.closest('tr').remove()">Ã—</button></td>
        `;
        document.getElementById('scheduleBody').appendChild(tr);
    }

    function getOptions(selected) {
        const shifts = ["", "7-3", "8-5", "3-11", "11-7", "OFF", "LEAVE"];
        return shifts.map(s => `<option value="${s}" ${s === selected ? 'selected' : ''}>${s}</option>`).join('');
    }

    function saveData() {
        const weekKey = currentSat.toDateString();
        const schedKey = weekKey + "_" + currentDept;
        
        const rows = [];
        document.querySelectorAll('#scheduleBody tr').forEach(tr => {
            rows.push({
                name: tr.querySelector('.staff-name').innerText,
                role: tr.querySelector('.staff-role').innerText,
                shifts: Array.from(tr.querySelectorAll('select')).map(s => s.value)
            });
        });

        db.schedules[schedKey] = rows;
        
        // Save Signatories
        db.sigs[currentDept] = {
            pName: document.getElementById('prepName').innerText,
            pRole: document.getElementById('prepRole').innerText,
            aName: document.getElementById('apprName').innerText,
            aRole: document.getElementById('apprRole').innerText
        };

        localStorage.setItem('LDH_DB', JSON.stringify(db));
        alert("Schedule Saved!");
    }

    function loadSigs() {
        let s = db.sigs[currentDept];
        if (s) {
            document.getElementById('prepName').innerText = s.pName;
            document.getElementById('prepRole').innerText = s.pRole;
            document.getElementById('apprName').innerText = s.aName;
            document.getElementById('apprRole').innerText = s.aRole;
        }
    }

    function changeWeek(days) {
        saveData(); // Save before leaving
        currentSat.setDate(currentSat.getDate() + days);
        loadData();
    }

    // Masterlist Logic
    function openMasterlist() {
        document.getElementById('mlModal').style.display = 'flex';
        const tbody = document.getElementById('mlBody');
        tbody.innerHTML = "";
        let ml = db.masterlists[currentDept] || [];
        ml.forEach(s => addMlRow(s.name, s.role));
    }

    function addMlRow(n="", r="") {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${n}"></td>
            <td><input type="text" value="${r}"></td>
            <td><button onclick="this.closest('tr').remove()">Ã—</button></td>
        `;
        document.getElementById('mlBody').appendChild(tr);
    }

    function saveMasterlist() {
        let ml = [];
        document.querySelectorAll('#mlBody tr').forEach(tr => {
            let inputs = tr.querySelectorAll('input');
            if(inputs[0].value) ml.push({ name: inputs[0].value, role: inputs[1].value });
        });
        db.masterlists[currentDept] = ml;
        localStorage.setItem('LDH_DB', JSON.stringify(db));
        closeMasterlist();
        loadData(); // Force refresh main table
    }

    function closeMasterlist() { document.getElementById('mlModal').style.display = 'none'; }
</script>

</body>
</html>
